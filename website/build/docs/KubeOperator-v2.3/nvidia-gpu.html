<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>九、GPU 与机器学习 · 在线文档</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="除了传统的无状态 Web 应用外，越来越多的数据库 Workload、实时计算 Workload、AI 机器学习 Workload 会跑在 K8s 之上。其中，尤其是 AI 机器学习，天然适合运行在 K8s 之上。对于一些用户，其构建 K8s 集群就是专门用来运行机器学习、通用 GPU、高性能计算，以及受益于专用硬件加速器的其他工作负载。"/><meta name="docsearch:version" content="2.3"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="九、GPU 与机器学习 · 在线文档"/><meta property="og:type" content="website"/><meta property="og:url" content="https://docs.kubeoperator.io/"/><meta property="og:description" content="除了传统的无状态 Web 应用外，越来越多的数据库 Workload、实时计算 Workload、AI 机器学习 Workload 会跑在 K8s 之上。其中，尤其是 AI 机器学习，天然适合运行在 K8s 之上。对于一些用户，其构建 K8s 集群就是专门用来运行机器学习、通用 GPU、高性能计算，以及受益于专用硬件加速器的其他工作负载。"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-147297392-2"></script><script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments); }
              gtag('js', new Date());
              gtag('config', 'UA-147297392-2');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script><script type="text/javascript" src="/js/code-block-buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/kubeOperator-white.png" alt="在线文档"/><h2 class="headerTitleWithLogo">在线文档</h2></a><a href="/versions"><h3>2.3</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="https://kubeoperator.io" target="_blank">网站</a></li><li class=""><a href="https://github.com/KubeOperator/KubeOperator" target="_blank">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="搜索" title="搜索"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>KubeOperator-v2.3</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">KubeOperator-v2.3<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/KubeOperator-v2.3/introduction">一、关于 KubeOperator</a></li><li class="navListItem"><a class="navItem" href="/KubeOperator-v2.3/concept">二、KubeOperator 的主要概念</a></li><li class="navListItem"><a class="navItem" href="/KubeOperator-v2.3/installation">三、安装和升级 KubeOperator</a></li><li class="navListItem"><a class="navItem" href="/KubeOperator-v2.3/userguide-manual">四、在自行准备的主机上规划、部署及运营 K8s 集群</a></li><li class="navListItem"><a class="navItem" href="/KubeOperator-v2.3/userguide-vsphere">五、在 vSphere 平台上规划、部署及运营 K8s 集群</a></li><li class="navListItem"><a class="navItem" href="/KubeOperator-v2.3/userguide-openstack">六、在 OpenStack 平台上规划、部署及运营 K8s 集群</a></li><li class="navListItem"><a class="navItem" href="/KubeOperator-v2.3/userguide-aliyun">七、在阿里云 平台上规划、部署及运营 K8s 集群</a></li><li class="navListItem"><a class="navItem" href="/KubeOperator-v2.3/kubeapps-plus">八、安装和使用应用商店</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/KubeOperator-v2.3/nvidia-gpu">九、GPU 与机器学习</a></li><li class="navListItem"><a class="navItem" href="/KubeOperator-v2.3/faq">十、常见问题</a></li><li class="navListItem"><a class="navItem" href="/KubeOperator-v2.3/video">十一、视频演示</a></li><li class="navListItem"><a class="navItem" href="/KubeOperator-v2.3/screenshot">十二、功能截屏</a></li><li class="navListItem"><a class="navItem" href="/KubeOperator-v2.3/support">十三、技术支持</a></li><li class="navListItem"><a class="navItem" href="/KubeOperator-v2.3/known-issue">十四、已知问题</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">九、GPU 与机器学习</h1></header><article><div><span><p>除了传统的无状态 Web 应用外，越来越多的数据库 Workload、实时计算 Workload、AI 机器学习 Workload 会跑在 K8s 之上。其中，尤其是 AI 机器学习，天然适合运行在 K8s 之上。对于一些用户，其构建 K8s 集群就是专门用来运行机器学习、通用 GPU、高性能计算，以及受益于专用硬件加速器的其他工作负载。</p>
<h2><a class="anchor" aria-hidden="true" id="1-使用-kubeoperator-部署带有-gpu-的-kubernetes-集群"></a><a href="#1-使用-kubeoperator-部署带有-gpu-的-kubernetes-集群" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1 使用 Kubeoperator 部署带有 GPU 的 Kubernetes 集群</h2>
<h3><a class="anchor" aria-hidden="true" id="11-先决条件"></a><a href="#11-先决条件" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.1 先决条件</h3>
<ul>
<li>至少一台 Worker 节点拥有 NVIDIA GPU 显卡设备</li>
<li>Kubernetes 1.6.X: Package &gt;= 1.16.4</li>
<li>Kubernetes 1.5.X: Package &gt;= 1.15.7</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="12-集群规划"></a><a href="#12-集群规划" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.2 集群规划</h3>
<table>
<thead>
<tr><th>name</th><th>CPU (核心)</th><th>内存 （GB）</th><th>操作系统</th><th>GPU (个)</th><th>角色</th></tr>
</thead>
<tbody>
<tr><td>master</td><td>4</td><td>8</td><td>CentOS 7.6</td><td>0</td><td>Master</td></tr>
<tr><td>worker1</td><td>4</td><td>20</td><td>CentOS 7.6</td><td>1</td><td>Worker</td></tr>
<tr><td>worker2</td><td>4</td><td>8</td><td>CentOS 7.6</td><td>0</td><td>Worker</td></tr>
<tr><td>nfs</td><td>1</td><td>2</td><td>CentOS 7.6</td><td>0</td><td>NFS</td></tr>
</tbody>
</table>
<h3><a class="anchor" aria-hidden="true" id="13-添加-gpu-主机"></a><a href="#13-添加-gpu-主机" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.3 添加 GPU 主机</h3>
<p><img src="../../../img-nivdia/gpu-host-list.jpg" alt="gpu-host-list"></p>
<p><img src="../../../img-nivdia/gpu-host-detail.png" alt="gpu-host-detail"></p>
<h3><a class="anchor" aria-hidden="true" id="14-创建集群"></a><a href="#14-创建集群" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.4 创建集群</h3>
<p>部署步骤请参考在自行准备的主机上部署 k8s 集群。</p>
<h3><a class="anchor" aria-hidden="true" id="15-验证-gpu-调度"></a><a href="#15-验证-gpu-调度" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1.5 验证 GPU 调度</h3>
<p>使用 Webkubectl 进入集群 Terminal, 新建文件 gpu.yml 并输入以下内容:</p>
<pre><code class="hljs"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">nvidia-deployment</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span>                <span class="hljs-comment"># 创建POD副本数</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">nvidia-gpu-deploy</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">nvidia-gpu-deploy</span>

    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cuda-container</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">ubuntu</span>
        <span class="hljs-attr">command:</span> <span class="hljs-string">["sleep"]</span>
        <span class="hljs-attr">args:</span> <span class="hljs-string">["100000"]</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">nvidia.com/gpu:</span> <span class="hljs-number">1</span>       <span class="hljs-comment"># 使用 GPU 卡的数量</span>
</code></pre>
<pre><code class="hljs">kubectl apply -f gpu.yml

kubectl <span class="hljs-keyword">get</span> pod

NAME                                READY   STATUS    RESTARTS   AGE
nvidia-deployment<span class="hljs-number">-64589</span>d94d<span class="hljs-number">-8</span>m6rd   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">119</span>s  # 获取到显卡 Running
nvidia-deployment<span class="hljs-number">-64589</span>d94d-lzfph   <span class="hljs-number">0</span>/<span class="hljs-number">1</span>     Pending   <span class="hljs-number">0</span>          <span class="hljs-number">86</span>s   # 未获取到显卡 Pending

kubectl exec -it nvidia-deployment<span class="hljs-number">-64589</span>d94d<span class="hljs-number">-8</span>m6rd nvidia-smi

Mon Jan <span class="hljs-number">13</span> <span class="hljs-number">08</span>:<span class="hljs-number">16</span>:<span class="hljs-number">36</span> <span class="hljs-number">2020</span>
+-----------------------------------------------------------------------------+
| NVIDIA-SMI <span class="hljs-number">440.33</span><span class="hljs-number">.01</span>    Driver Version: <span class="hljs-number">440.33</span><span class="hljs-number">.01</span>    CUDA Version: N/A      |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|===============================+======================+======================|
|   <span class="hljs-number">0</span>  Tesla P4            Off  | <span class="hljs-number">00000000</span>:<span class="hljs-number">00</span>:<span class="hljs-number">06.0</span> Off |                    <span class="hljs-number">0</span> |
| N/A   <span class="hljs-number">33</span>C    P8     <span class="hljs-number">7</span>W /  <span class="hljs-number">75</span>W |      <span class="hljs-number">0</span>MiB /  <span class="hljs-number">7611</span>MiB |      <span class="hljs-number">0</span>%      Default |
+-------------------------------+----------------------+----------------------+

+-----------------------------------------------------------------------------+
| Processes:                                                       GPU Memory |
|  GPU       PID   Type   Process name                             Usage      |
|=============================================================================|
|  No running processes found                                                 |
+-----------------------------------------------------------------------------+
# POD 中已经可以访问到 GPU 设备

</code></pre>
<h2><a class="anchor" aria-hidden="true" id="2tensorflow-on-kubernetes"></a><a href="#2tensorflow-on-kubernetes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.Tensorflow on Kubernetes</h2>
<h3><a class="anchor" aria-hidden="true" id="21-关于-tensorflow"></a><a href="#21-关于-tensorflow" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.1 关于 Tensorflow</h3>
<p><a href="https://www.tensorflow.org/">TensorFlow</a> 是一个端到端开源机器学习平台。它拥有一个包含各种工具、库和社区资源的全面灵活生态系统，可以让研究人员推动机器学习领域的先进技术的发展，并让开发者轻松地构建和部署由机器学习提供支持的应用。</p>
<h3><a class="anchor" aria-hidden="true" id="22-在-kuberneters-中安装-tensorflow"></a><a href="#22-在-kuberneters-中安装-tensorflow" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.2 在 Kuberneters 中安装 Tensorflow</h3>
<p>使用 Webkubectl 进入集群 Terminal, 新建文件 tensorflow.yml 并输入以下内容:</p>
<pre><code class="hljs">
<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">tensorflow-pvc</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">accessModes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">requests:</span>
      <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">tensorflow</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">tensorflow</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">tensorflow</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tensorflow</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">registry.cn-hangzhou.aliyuncs.com/tensorflow-samples/jupyter:1.1.0-devel-gpu</span>
        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">PASSWORD</span>
            <span class="hljs-attr">value:</span> <span class="hljs-string">mypassw0rd</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">nvidia.com/gpu:</span> <span class="hljs-number">1</span>
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/usr/local/nvidia</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">nvidia</span>
      <span class="hljs-attr">volumes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nvidia</span>
          <span class="hljs-attr">persistentVolumeClaim:</span>
            <span class="hljs-attr">claimName:</span> <span class="hljs-string">tensorflow-pvc</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">tensorflow-svc</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span>
  <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tensorflow-port</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8888</span>
  <span class="hljs-attr">selector:</span>
     <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">tensorflow</span>
</code></pre>
<pre><code class="hljs">kubectl apply -f tensorflow.yml

persistentvolumeclaim/tensorflow-pvc configured
deployment.apps/tensorflow configured
service/tensorflow-svc configured

kubectl <span class="hljs-builtin-name">get</span> pod

NAME                                   READY   STATUS    RESTARTS   AGE
tensorflow-79c5f4c48c-94l82            1/1     Running   0          101s

kubectl <span class="hljs-builtin-name">get</span> svc

NAME            <span class="hljs-built_in"> TYPE </span>      CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
tensorflow-svc   NodePort   179.10.100.67   &lt;none&gt;        80:32604/TCP   2m15s

</code></pre>
<p>访问 <a href="http://NODE">http://NODE</a>_IP:32604 访问 Jupyter</p>
<p><img src="../../../img-nivdia/tensorflow-login.png" alt="jupter-login"></p>
<h3><a class="anchor" aria-hidden="true" id="23-开始一个-tensorflow-机器学习示例"></a><a href="#23-开始一个-tensorflow-机器学习示例" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.3 开始一个 Tensorflow 机器学习示例</h3>
<h4><a class="anchor" aria-hidden="true" id="231-打开一个终端"></a><a href="#231-打开一个终端" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.3.1 打开一个终端</h4>
<p><img src="../../../img-nivdia/tensorflow-select-terminal.png" alt="jupter-select-terminal"></p>
<p><img src="../../../img-nivdia/tensorflow-terminal.png" alt="jupter-terminal"></p>
<h4><a class="anchor" aria-hidden="true" id="232-使用-pip-下载-keras"></a><a href="#232-使用-pip-下载-keras" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.3.2 使用 PIP 下载 KERAS</h4>
<pre><code class="hljs">pip install keras==<span class="hljs-number">2.0</span><span class="hljs-number">.6</span>
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="233-代码实现"></a><a href="#233-代码实现" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.3.3 代码实现</h4>
<pre><code class="hljs">import keras
<span class="hljs-keyword">from</span> tensorflow.python.client import device_lib

<span class="hljs-comment"># 获取 GPU 信息</span>
num_gpus = sum([1 <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> local_device_protos <span class="hljs-keyword">if</span> d.device_type == <span class="hljs-string">'GPU'</span>])
<span class="hljs-builtin-name">print</span>(<span class="hljs-string">"GPU : {}"</span>.format(num_gpus))

<span class="hljs-comment"># 下载 MNIST 数据集</span>
mnist = keras.datasets.mnist
(x_train, y_train), (x_test, y_test) = mnist.load_data()
x_train, x_test = x_train / 255.0, x_test / 255.0


<span class="hljs-comment"># 将模型的各层堆叠起来，以搭建 keras.Sequential 模型。为训练选择优化器和损失函数：</span>
model = keras.models.Sequential([
  keras.layers.Flatten(input_shape=(28, 28)),
  keras.layers.Dense(128, <span class="hljs-attribute">activation</span>=<span class="hljs-string">'relu'</span>),
  keras.layers.Dropout(0.2),
  keras.layers.Dense(10, <span class="hljs-attribute">activation</span>=<span class="hljs-string">'softmax'</span>)
])

model.compile(<span class="hljs-attribute">optimizer</span>=<span class="hljs-string">'adam'</span>,
              <span class="hljs-attribute">loss</span>=<span class="hljs-string">'sparse_categorical_crossentropy'</span>,
              metrics=[<span class="hljs-string">'accuracy'</span>])

<span class="hljs-comment"># 训练并验证模型</span>
model.fit(x_train, y_train, <span class="hljs-attribute">epochs</span>=5)
model.evaluate(x_test,  y_test, <span class="hljs-attribute">verbose</span>=2)

</code></pre>
<h4><a class="anchor" aria-hidden="true" id="234-运行学习服务"></a><a href="#234-运行学习服务" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2.3.4 运行学习服务</h4>
<pre><code class="hljs css language-bash">python mnist.py

Epoch 1/5
60000/60000 [==============================] - 9s - loss: 0.2984 - acc: 0.9137     
Epoch 2/5
60000/60000 [==============================] - 7s - loss: 0.1422 - acc: 0.9575     
Epoch 3/5
60000/60000 [==============================] - 7s - loss: 0.1102 - acc: 0.9671     
Epoch 4/5
60000/60000 [==============================] - 7s - loss: 0.0885 - acc: 0.9728     
Epoch 5/5
60000/60000 [==============================] - 7s - loss: 0.0758 - acc: 0.9761 

[0.074264542010473084, 0.97750000000000004] <span class="hljs-comment">#这个照片分类器的准确度已经达到 98%</span>

</code></pre>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 1/14/2020</em></div><div class="docs-prevnext"><a class="docs-prev button" href="/KubeOperator-v2.3/kubeapps-plus"><span class="arrow-prev">← </span><span>Previous</span></a><a class="docs-next button" href="/KubeOperator-v2.3/faq"><span>Next</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#1-使用-kubeoperator-部署带有-gpu-的-kubernetes-集群">1 使用 Kubeoperator 部署带有 GPU 的 Kubernetes 集群</a><ul class="toc-headings"><li><a href="#11-先决条件">1.1 先决条件</a></li><li><a href="#12-集群规划">1.2 集群规划</a></li><li><a href="#13-添加-gpu-主机">1.3 添加 GPU 主机</a></li><li><a href="#14-创建集群">1.4 创建集群</a></li><li><a href="#15-验证-gpu-调度">1.5 验证 GPU 调度</a></li></ul></li><li><a href="#2tensorflow-on-kubernetes">2.Tensorflow on Kubernetes</a><ul class="toc-headings"><li><a href="#21-关于-tensorflow">2.1 关于 Tensorflow</a></li><li><a href="#22-在-kuberneters-中安装-tensorflow">2.2 在 Kuberneters 中安装 Tensorflow</a></li><li><a href="#23-开始一个-tensorflow-机器学习示例">2.3 开始一个 Tensorflow 机器学习示例</a></li></ul></li></ul></nav></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '478e01143cbab954ebdc8ad0a654ffa3',
                indexName: 'kubeoperator',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>